<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>社區知識庫管理後台</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"></link>
  <style>
    body { font-family: 'Noto Sans TC', sans-serif; }
    textarea { font-family: 'monospace'; }
    .version-card, .log-card {
        transition: all 0.2s ease-in-out;
    }
    .version-card:hover, .log-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    }
    .fa-spinner {
        animation: spin 1s linear infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    /* 讓 modal 置中 */
    .modal {
        display: none; /* 預設隱藏 */
    }
    .modal.active {
        display: flex;
    }
  </style>
</head>
<body class="bg-gray-50">
  <div class="max-w-6xl mx-auto p-4 sm:p-8 bg-white shadow-xl mt-12 mb-12 rounded-2xl">
    <div class="text-center">
      <h1 class="text-4xl font-extrabold text-gray-800">社區 AI 助理儀表板</h1>
      <p class="text-gray-500 mt-2 text-lg">一站式管理知識庫、建議按鈕並分析使用數據</p>
    </div>

    <div id="statusMessage" class="mt-6 text-center h-8 text-sm"></div>

    <!-- 數據分析儀表板 -->
    <div class="mt-12 border-t pt-8">
        <h2 class="text-3xl font-bold text-gray-700 mb-6">使用數據分析</h2>
        <!-- 統計數據卡片 -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="bg-blue-50 p-6 rounded-2xl text-center shadow-sm">
                <p class="text-lg font-semibold text-blue-800">總查詢次數</p>
                <p id="total-queries" class="text-4xl font-extrabold text-blue-600 mt-2">0</p>
            </div>
            <div class="bg-green-50 p-6 rounded-2xl text-center shadow-sm">
                <p class="text-lg font-semibold text-green-800">有幫助的回饋</p>
                <p id="helpful-feedback" class="text-4xl font-extrabold text-green-600 mt-2">0</p>
            </div>
            <div class="bg-red-50 p-6 rounded-2xl text-center shadow-sm">
                <p class="text-lg font-semibold text-red-800">沒幫助的回饋</p>
                <p id="unhelpful-feedback" class="text-4xl font-extrabold text-red-600 mt-2">0</p>
            </div>
        </div>
        <!-- 查詢記錄列表 -->
        <h3 class="text-2xl font-bold text-gray-700 mb-4">最新查詢記錄</h3>
        <div id="logsList" class="space-y-4">
            <!-- 查詢記錄會顯示在這裡 -->
        </div>
    </div>


    <div class="mt-12 border-t pt-8">
      <h2 class="text-3xl font-bold text-gray-700 mb-6">知識庫管理</h2>
      <div class=" p-6 bg-blue-50 rounded-xl">
        <label for="knowledgeBaseInput" class="block text-xl font-bold text-gray-700">編輯區 (目前顯示為最新版本)</label>
        <textarea id="knowledgeBaseInput" rows="15" class="mt-3 block w-full rounded-xl border-blue-200 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-4 text-sm leading-relaxed"></textarea>
        <p class="mt-2 text-sm text-gray-500">提示：您可以使用 `#`、`**文字**`、`-` 等 Markdown 語法來美化格式。</p>
      </div>
      <div class="mt-6 text-right">
        <button id="saveBtn" class="py-3 px-8 border border-transparent rounded-full shadow-lg text-base font-bold text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-transform transform hover:-translate-y-1 disabled:bg-gray-400 disabled:transform-none">
          發布新版本
        </button>
      </div>
      <div class="mt-8">
          <h3 class="text-2xl font-bold text-gray-700 mb-6">歷史版本</h3>
          <div id="historyList" class="space-y-4"></div>
      </div>
    </div>

    <div class="mt-12 border-t pt-8">
        <h2 class="text-3xl font-bold text-gray-700 mb-6">自定義快速建議按鈕</h2>
        <div id="suggestionsAdmin" class="space-y-6">
            <!-- Suggestion admin fields will be rendered here -->
        </div>
        <div class="mt-6 text-right">
            <button id="saveSuggestionsBtn" class="py-3 px-8 border border-transparent rounded-full shadow-lg text-base font-bold text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition-transform transform hover:-translate-y-1 disabled:bg-gray-400 disabled:transform-none">
                儲存建議按鈕
            </button>
        </div>
    </div>
  </div>

  <!-- Modal 用於顯示完整 AI 回覆 -->
  <div id="responseModal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center p-4 z-50">
      <div class="bg-white rounded-2xl shadow-xl max-w-2xl w-full max-h-[80vh] flex flex-col">
          <div class="p-4 border-b flex justify-between items-center">
              <h3 class="text-lg font-bold">完整 AI 回覆</h3>
              <button id="closeModalBtn" class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
          </div>
          <div id="modalContent" class="p-6 overflow-y-auto" style="white-space: pre-wrap;"></div>
      </div>
  </div>


  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, collection, onSnapshot, addDoc, deleteDoc, serverTimestamp, query, orderBy, getDoc, setDoc, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // --- 設定 ---
    const USER_PROVIDED_API_KEY = "AIzaSyCspWUkVA6STWgjrLeXVgg5JnWnJWTKAtU";
    const SUGGESTION_BUTTONS_COUNT = 4;

    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    let firebaseConfig;
    let useTokenAuth = false;

    if (typeof __firebase_config !== 'undefined' && __firebase_config) {
        firebaseConfig = JSON.parse(__firebase_config);
        useTokenAuth = true;
    } else {
        console.warn("未偵測到 Firebase 環境設定，將使用備用設定。");
        firebaseConfig = {
            apiKey: "AIzaSyDeRHsloR1iY0_bzpYbPzdCiBljGfck98k",
            authDomain: "jy-2025.firebaseapp.com",
            projectId: "jy-2025",
            storageBucket: "jy-2025.appspot.com",
            messagingSenderId: "640527461851",
            appId: "1:640527461851:web:eed9f82d698275371fcbfe",
            measurementId: "G-HVEVMTSR9L"
        };
    }
    
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
    const versionsPath = `/artifacts/${appId}/public/data/knowledge_base_versions`;
    const suggestionsDocPath = `/artifacts/${appId}/public/data/community_info/suggestions_config`;
    const usageLogsPath = `/artifacts/${appId}/public/data/usage_logs`;

    // --- DOM 元素 ---
    const knowledgeBaseInput = document.getElementById('knowledgeBaseInput');
    const saveBtn = document.getElementById('saveBtn');
    const statusMessage = document.getElementById('statusMessage');
    const historyList = document.getElementById('historyList');
    const suggestionsAdmin = document.getElementById('suggestionsAdmin');
    const saveSuggestionsBtn = document.getElementById('saveSuggestionsBtn');
    const totalQueriesEl = document.getElementById('total-queries');
    const helpfulFeedbackEl = document.getElementById('helpful-feedback');
    const unhelpfulFeedbackEl = document.getElementById('unhelpful-feedback');
    const logsListEl = document.getElementById('logsList');
    const responseModal = document.getElementById('responseModal');
    const modalContent = document.getElementById('modalContent');
    const closeModalBtn = document.getElementById('closeModalBtn');


    // --- 全域變數 ---
    let db, auth;

    async function initializeFirebase() {
      try {
        const app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);
        
        if (useTokenAuth && initialAuthToken) {
          await signInWithCustomToken(auth, initialAuthToken);
        } else {
          await signInAnonymously(auth);
        }
        
        setupKnowledgeBaseListener();
        loadSuggestions();
        setupUsageLogListener();

      } catch (e) {
        console.error("Firebase 初始化失敗:", e);
        showStatus("無法連接至伺服器。", 'error');
      }
    }

    function showStatus(message, type = 'info') {
        statusMessage.innerHTML = message;
        statusMessage.className = `mt-6 text-center h-8 text-sm flex items-center justify-center rounded-lg ${
            type === 'error' ? 'bg-red-100 text-red-700' :
            type === 'success' ? 'bg-green-100 text-green-700' : 'text-gray-500'
        }`;
        if (type === 'success') {
            setTimeout(() => {
                statusMessage.innerHTML = '';
                statusMessage.className = `mt-6 text-center h-8`;
            }, 3000);
        }
    }

    // --- 知識庫管理 ---
    function setupKnowledgeBaseListener() {
        showStatus(`<i class="fas fa-spinner fa-spin mr-2"></i>正在從資料庫載入資料...`);
        saveBtn.disabled = true;
        const versionsCollectionRef = collection(db, versionsPath);
        const q = query(versionsCollectionRef, orderBy("timestamp", "desc"));

        onSnapshot(q, (snapshot) => {
            const versions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            
            if (versions.length > 0) {
                knowledgeBaseInput.value = versions[0].content;
                renderHistoryList(versions);
            } else {
                knowledgeBaseInput.value = `# 歡迎使用\n\n請在此輸入您的第一版社區資訊...`;
                historyList.innerHTML = `<p class="text-gray-500 text-center">尚無歷史版本。</p>`;
                showStatus("尚未建立知識庫，請輸入內容後發布。");
            }
            saveBtn.disabled = false;
        }, (error) => {
            console.error("載入知識庫失敗:", error);
            showStatus("載入知識庫失敗，請檢查網路連線或權限設定。", 'error');
        });
    }

    function renderHistoryList(versions) {
        historyList.innerHTML = '';
        versions.forEach((version, index) => {
            const card = document.createElement('div');
            card.className = 'version-card bg-white border border-gray-200 p-4 rounded-xl flex flex-col sm:flex-row justify-between items-start sm:items-center shadow-sm';
            const timestamp = version.timestamp ? version.timestamp.toDate().toLocaleString('zh-TW') : 'N/A';
            const cleanContent = version.content.replace(/#+\s/g, '').replace(/:\w+:\w+:\d+]/g, '');
            const contentPreview = cleanContent.substring(0, 80).replace(/\n/g, ' ') + '...';

            card.innerHTML = `
                <div class="flex-grow">
                    <p class="font-bold text-gray-800 text-lg">
                        版本 ${timestamp} ${index === 0 ? '<span class="text-xs font-medium bg-green-100 text-green-800 py-1 px-2 rounded-full ml-2">最新</span>' : ''}
                    </p>
                    <p class="text-sm text-gray-500 mt-1">${contentPreview}</p>
                </div>
                <div class="flex space-x-2 mt-4 sm:mt-0">
                    <button data-content="${escape(version.content)}" class="load-btn py-2 px-4 bg-gray-100 text-gray-700 hover:bg-gray-200 rounded-lg text-sm transition-colors">載入此版本</button>
                    <button data-id="${version.id}" class="delete-btn text-red-500 hover:text-red-700 text-xl transition-colors"><i class="fas fa-trash-alt"></i></button>
                </div>
            `;
            historyList.appendChild(card);
        });
    }

    async function saveNewVersion() {
        const content = knowledgeBaseInput.value;
        if (!content.trim()) {
            showStatus("內容不能為空！", "error");
            return;
        }
        showStatus(`<i class="fas fa-spinner fa-spin mr-2"></i>正在發布新版本...`);
        saveBtn.disabled = true;
        try {
            await addDoc(collection(db, versionsPath), {
                content: content,
                timestamp: serverTimestamp()
            });
            showStatus("新版本已成功發布！", 'success');
        } catch (error) {
            console.error("發布失敗:", error);
            showStatus("發布失敗，請重試。", 'error');
        } finally {
            saveBtn.disabled = false;
        }
    }

    async function deleteVersion(id) {
        showStatus(`<i class="fas fa-spinner fa-spin mr-2"></i>正在刪除版本...`);
        try {
            await deleteDoc(doc(db, versionsPath, id));
            showStatus("版本已刪除。", 'success');
        } catch (error) {
            console.error("刪除失敗:", error);
            showStatus("刪除失敗，請重試。", 'error');
        }
    }
    
    // --- 建議按鈕管理 ---
    // **修正**: 補上遺漏的函式實作
    function renderSuggestionsAdmin(suggestions = []) {
        suggestionsAdmin.innerHTML = '';
        for (let i = 0; i < SUGGESTION_BUTTONS_COUNT; i++) {
            const suggestion = suggestions[i] || { zh: { text: '', query: '' }, ja: { text: '', query: '' } };
            const section = document.createElement('div');
            section.className = 'p-6 border-2 border-gray-200 rounded-xl bg-gray-100 shadow-inner';
            section.innerHTML = `
                <h3 class="font-bold text-lg mb-4 flex justify-between items-center text-gray-800">
                    <span>按鈕 ${i + 1}</span>
                    <button class="translate-btn text-sm py-2 px-4 rounded-full bg-blue-100 text-blue-700 hover:bg-blue-200 transition-colors" data-index="${i}">
                        <i class="fas fa-language mr-1"></i> 將中文翻譯至日文
                    </button>
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">按鈕文字 (中文)</label>
                        <input type="text" id="zh-text-${i}" value="${suggestion.zh.text}" class="mt-1 p-3 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">發送問題 (中文)</label>
                        <input type="text" id="zh-query-${i}" value="${suggestion.zh.query}" class="mt-1 p-3 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">按鈕文字 (日文)</label>
                        <input type="text" id="ja-text-${i}" value="${suggestion.ja.text}" class="mt-1 p-3 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">發送問題 (日文)</label>
                        <input type="text" id="ja-query-${i}" value="${suggestion.ja.query}" class="mt-1 p-3 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                    </div>
                </div>
            `;
            suggestionsAdmin.appendChild(section);
        }
    }

    async function loadSuggestions() {
        saveSuggestionsBtn.disabled = true;
        try {
            const docRef = doc(db, suggestionsDocPath);
            const docSnap = await getDoc(docRef);
            if (docSnap.exists()) {
                renderSuggestionsAdmin(docSnap.data().suggestions);
            } else {
                renderSuggestionsAdmin(); // Render with empty fields
            }
        } catch (error) {
            console.error("載入建議按鈕失敗:", error);
            showStatus("載入建議按鈕失敗。", 'error');
        } finally {
            saveSuggestionsBtn.disabled = false;
        }
    }

    async function saveSuggestions() {
        showStatus(`<i class="fas fa-spinner fa-spin mr-2"></i>正在儲存建議按鈕...`);
        saveSuggestionsBtn.disabled = true;
        const suggestions = [];
        for (let i = 0; i < SUGGESTION_BUTTONS_COUNT; i++) {
            suggestions.push({
                zh: {
                    text: document.getElementById(`zh-text-${i}`).value,
                    query: document.getElementById(`zh-query-${i}`).value
                },
                ja: {
                    text: document.getElementById(`ja-text-${i}`).value,
                    query: document.getElementById(`ja-query-${i}`).value
                }
            });
        }
        
        try {
            const docRef = doc(db, suggestionsDocPath);
            await setDoc(docRef, { suggestions });
            showStatus("建議按鈕已成功更新！", 'success');
        } catch (error) {
            console.error("儲存建議按鈕失敗:", error);
            showStatus("儲存建議按鈕失敗。", 'error');
        } finally {
            saveSuggestionsBtn.disabled = false;
        }
    }

    // --- AI 翻譯功能 ---
    async function translateText(text) {
        const apiKey = USER_PROVIDED_API_KEY || firebaseConfig.apiKey;
        if (!text || !apiKey) return text;

        try {
            const prompt = `Translate the following Chinese (Traditional) text to Japanese. Only return the translated text, without any explanation or extra characters. Text to translate: "${text}"`;
            const payload = { contents: [{ parts: [{ text: prompt }] }] };
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            if (!response.ok) {
                const errorBody = await response.text();
                throw new Error(`API request failed: ${response.status}. ${errorBody}`);
            }
            const result = await response.json();
            return result.candidates[0].content.parts[0].text.trim();
        } catch (error) {
            console.error('Translation failed:', error);
            showStatus(`翻譯失敗: ${error.message}`, 'error');
            return '';
        }
    }

    async function handleTranslation(event) {
        const btn = event.currentTarget;
        const index = btn.dataset.index;
        
        const zhTextInput = document.getElementById(`zh-text-${index}`);
        const zhQueryInput = document.getElementById(`zh-query-${index}`);
        const jaTextInput = document.getElementById(`ja-text-${index}`);
        const jaQueryInput = document.getElementById(`ja-query-${index}`);

        const originalButtonHTML = btn.innerHTML;
        btn.innerHTML = `<i class="fas fa-spinner fa-spin mr-1"></i> 翻譯中...`;
        btn.disabled = true;

        try {
            const [translatedText, translatedQuery] = await Promise.all([
                translateText(zhTextInput.value),
                translateText(zhQueryInput.value)
            ]);
            
            jaTextInput.value = translatedText;
            jaQueryInput.value = translatedQuery;
            showStatus('翻譯完成！', 'success');
        } catch (error) {
            // Error is already shown in translateText function
        } finally {
            btn.innerHTML = originalButtonHTML;
            btn.disabled = false;
        }
    }

    // --- 數據分析功能 ---
    function setupUsageLogListener() {
        const logsCollectionRef = collection(db, usageLogsPath);
        const q = query(logsCollectionRef, orderBy("timestamp", "desc"), limit(50));

        onSnapshot(q, (snapshot) => {
            const logs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            updateStats(logs);
            renderLogList(logs);
            showStatus("儀表板數據已更新！", 'success');
        }, (error) => {
            console.error("載入使用記錄失敗:", error);
            showStatus("載入使用記錄失敗。", 'error');
            logsListEl.innerHTML = `<p class="text-red-500 text-center">無法載入查詢記錄。</p>`;
        });
    }

    function updateStats(logs) {
        const total = logs.length;
        const helpful = logs.filter(log => log.satisfaction === 'helpful').length;
        const unhelpful = logs.filter(log => log.satisfaction === 'unhelpful').length;

        totalQueriesEl.textContent = total;
        helpfulFeedbackEl.textContent = helpful;
        unhelpfulFeedbackEl.textContent = unhelpful;
    }

    function renderLogList(logs) {
        logsListEl.innerHTML = '';
        if (logs.length === 0) {
            logsListEl.innerHTML = `<p class="text-gray-500 text-center">尚無任何查詢記錄。</p>`;
            return;
        }

        logs.forEach(log => {
            const card = document.createElement('div');
            card.className = 'log-card bg-white border border-gray-200 p-4 rounded-xl shadow-sm flex flex-col sm:flex-row justify-between items-start';
            
            const timestamp = log.timestamp ? log.timestamp.toDate().toLocaleString('zh-TW') : 'N/A';
            let feedbackIcon = '';
            switch(log.satisfaction) {
                case 'helpful':
                    feedbackIcon = `<span class="flex items-center text-green-600"><i class="fas fa-thumbs-up mr-2"></i> 有幫助</span>`;
                    break;
                case 'unhelpful':
                    feedbackIcon = `<span class="flex items-center text-red-600"><i class="fas fa-thumbs-down mr-2"></i> 沒幫助</span>`;
                    break;
                default:
                    feedbackIcon = `<span class="flex items-center text-gray-500"><i class="fas fa-circle-notch mr-2"></i> 未回饋</span>`;
            }

            card.innerHTML = `
                <div class="flex-grow">
                    <p class="text-xs text-gray-500">${timestamp}</p>
                    <p class="font-semibold text-gray-800 mt-2">問題：${log.query}</p>
                    <div class="text-sm text-gray-600 mt-2">回饋：${feedbackIcon}</div>
                </div>
                <div class="mt-4 sm:mt-0 sm:ml-4 flex-shrink-0">
                    <button class="view-response-btn py-2 px-4 bg-blue-100 text-blue-700 hover:bg-blue-200 rounded-lg text-sm transition-colors" data-response="${escape(log.response)}">
                        查看 AI 回覆
                    </button>
                </div>
            `;
            logsListEl.appendChild(card);
        });
    }

    function openResponseModal(response) {
        modalContent.textContent = unescape(response);
        responseModal.classList.add('active');
    }

    function closeResponseModal() {
        responseModal.classList.remove('active');
    }

    // --- 事件監聽 ---
    saveBtn.addEventListener('click', saveNewVersion);
    saveSuggestionsBtn.addEventListener('click', saveSuggestions);
    closeModalBtn.addEventListener('click', closeResponseModal);
    responseModal.addEventListener('click', (e) => {
        if (e.target === responseModal) closeResponseModal();
    });
    logsListEl.addEventListener('click', (e) => {
        const btn = e.target.closest('.view-response-btn');
        if (btn) {
            openResponseModal(btn.dataset.response);
        }
    });

    historyList.addEventListener('click', (e) => {
        const loadBtn = e.target.closest('.load-btn');
        if (loadBtn) {
            knowledgeBaseInput.value = unescape(loadBtn.dataset.content);
            window.scrollTo(0, 0);
            showStatus("舊版內容已載入編輯區，修改後可發布為新版本。");
        }
        const deleteBtn = e.target.closest('.delete-btn');
        if (deleteBtn) {
            if (confirm('您確定要永久刪除這個歷史版本嗎？此操作無法復原。')) {
                deleteVersion(deleteBtn.dataset.id);
            }
        }
    });
    suggestionsAdmin.addEventListener('click', (e) => {
        const translateBtn = e.target.closest('.translate-btn');
        if (translateBtn) {
            handleTranslation(e);
        }
    });


    // --- 初始化 ---
    initializeFirebase();
  </script>
</body>
</html>