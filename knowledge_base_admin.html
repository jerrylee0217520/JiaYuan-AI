<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>社區知識庫管理後台</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"></link>
  <style>
    body { font-family: 'Noto Sans TC', sans-serif; }
    textarea { font-family: 'monospace'; }
    .version-card {
        transition: all 0.2s ease-in-out;
    }
    .version-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    }
  </style>
</head>
<body class="bg-gray-100">
  <div class="max-w-4xl mx-auto p-6 bg-white shadow-lg mt-10 rounded-lg">
    <div class="text-center">
      <h1 class="text-3xl font-bold text-gray-800">社區知識庫管理後台</h1>
      <p class="text-gray-500 mt-2">在這裡更新的資訊，會即時同步給 AI 助理</p>
    </div>

    <div id="statusMessage" class="mt-4 text-center h-6"></div>

    <div class="mt-6">
      <label for="knowledgeBaseInput" class="block text-lg font-medium text-gray-700">編輯區 (目前顯示為最新版本)</label>
      <textarea id="knowledgeBaseInput" rows="15" class="mt-2 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-4 text-sm leading-6"></textarea>
      <p class="mt-2 text-sm text-gray-500">提示：您可以使用 `#`、`**文字**`、`-` 等 Markdown 語法來美化格式。</p>
    </div>

    <div class="mt-6 text-right">
      <button id="saveBtn" class="py-3 px-6 border border-transparent rounded-md shadow-sm text-base font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:bg-gray-400">
        發布新版本
      </button>
    </div>

    <div class="mt-10 border-t pt-6">
        <h2 class="text-2xl font-bold text-gray-700 mb-4">歷史版本</h2>
        <div id="historyList" class="space-y-4">
            <!-- History versions will be rendered here -->
        </div>
    </div>

  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, collection, onSnapshot, addDoc, deleteDoc, serverTimestamp, query, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // --- 設定 ---
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    let firebaseConfig;
    let useTokenAuth = false;

    if (typeof __firebase_config !== 'undefined' && __firebase_config) {
        firebaseConfig = JSON.parse(__firebase_config);
        useTokenAuth = true;
    } else {
        console.warn("未偵測到 Firebase 環境設定，將使用備用設定。");
        firebaseConfig = {
            apiKey: "AIzaSyDeRHsloR1iY0_bzpYbPzdCiBljGfck98k",
            authDomain: "jy-2025.firebaseapp.com",
            projectId: "jy-2025",
            storageBucket: "jy-2025.appspot.com",
            messagingSenderId: "640527461851",
            appId: "1:640527461851:web:eed9f82d698275371fcbfe",
            measurementId: "G-HVEVMTSR9L"
        };
    }
    
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
    // FIX: Corrected the Firestore collection path to have an odd number of segments.
    const versionsPath = `/artifacts/${appId}/public/data/knowledge_base_versions`;

    // --- DOM 元素 ---
    const knowledgeBaseInput = document.getElementById('knowledgeBaseInput');
    const saveBtn = document.getElementById('saveBtn');
    const statusMessage = document.getElementById('statusMessage');
    const historyList = document.getElementById('historyList');

    // --- 全域變數 ---
    let db, auth;

    async function initializeFirebase() {
      try {
        const app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);
        
        if (useTokenAuth && initialAuthToken) {
          await signInWithCustomToken(auth, initialAuthToken);
        } else {
          await signInAnonymously(auth);
        }
        
        setupRealtimeListener();
      } catch (e) {
        console.error("Firebase 初始化失敗:", e);
        showStatus("無法連接至伺服器。", 'error');
      }
    }

    function showStatus(message, type = 'info') {
        statusMessage.textContent = message;
        statusMessage.className = `mt-4 text-center h-6 ${
            type === 'error' ? 'text-red-600' :
            type === 'success' ? 'text-green-600' : 'text-gray-500'
        }`;
        if (type === 'success') {
            setTimeout(() => showStatus(''), 3000);
        }
    }

    function setupRealtimeListener() {
        showStatus("正在從資料庫載入資料...");
        saveBtn.disabled = true;
        const versionsCollectionRef = collection(db, versionsPath);
        const q = query(versionsCollectionRef, orderBy("timestamp", "desc"));

        onSnapshot(q, (snapshot) => {
            const versions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            
            if (versions.length > 0) {
                knowledgeBaseInput.value = versions[0].content; // Load the latest version into editor
                renderHistoryList(versions);
                showStatus("資料載入成功！", 'success');
            } else {
                knowledgeBaseInput.value = `# 歡迎使用\n\n請在此輸入您的第一版社區資訊...`;
                historyList.innerHTML = `<p class="text-gray-500 text-center">尚無歷史版本。</p>`;
                showStatus("尚未建立知識庫，請輸入內容後發布。");
            }
            saveBtn.disabled = false;
        }, (error) => {
            console.error("載入知識庫失敗:", error);
            showStatus("載入知識庫失敗，請檢查網路連線或權限設定。", 'error');
            saveBtn.disabled = false;
        });
    }

    function renderHistoryList(versions) {
        historyList.innerHTML = '';
        versions.forEach((version, index) => {
            const card = document.createElement('div');
            card.className = 'version-card bg-white border border-gray-200 p-4 rounded-lg flex justify-between items-center';
            
            const timestamp = version.timestamp ? version.timestamp.toDate().toLocaleString('zh-TW') : 'N/A';
            const contentPreview = version.content.substring(0, 80).replace(/\n/g, ' ') + '...';

            card.innerHTML = `
                <div>
                    <p class="font-bold text-gray-800">
                        版本 ${timestamp} ${index === 0 ? '<span class="text-xs font-medium bg-green-100 text-green-800 py-1 px-2 rounded-full ml-2">最新</span>' : ''}
                    </p>
                    <p class="text-sm text-gray-500 mt-1">${contentPreview}</p>
                </div>
                <div class="flex space-x-2">
                    <button data-content="${escape(version.content)}" class="load-btn py-2 px-3 bg-gray-100 text-gray-700 hover:bg-gray-200 rounded-md text-sm">載入此版本</button>
                    <button data-id="${version.id}" class="delete-btn text-red-500 hover:text-red-700 text-xl"><i class="fas fa-trash-alt"></i></button>
                </div>
            `;
            historyList.appendChild(card);
        });

        document.querySelectorAll('.load-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                knowledgeBaseInput.value = unescape(btn.dataset.content);
                window.scrollTo(0, 0);
                showStatus("舊版內容已載入編輯區，修改後可發布為新版本。");
            });
        });

        document.querySelectorAll('.delete-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                if (confirm('您確定要永久刪除這個歷史版本嗎？此操作無法復原。')) {
                    deleteVersion(btn.dataset.id);
                }
            });
        });
    }

    async function saveNewVersion() {
        const content = knowledgeBaseInput.value;
        if (!content.trim()) {
            showStatus("內容不能為空！", "error");
            return;
        }
        showStatus("正在發布新版本...");
        saveBtn.disabled = true;
        try {
            const versionsCollectionRef = collection(db, versionsPath);
            await addDoc(versionsCollectionRef, {
                content: content,
                timestamp: serverTimestamp()
            });
            // The onSnapshot listener will automatically refresh the view
            showStatus("新版本已成功發布！", 'success');
        } catch (error) {
            console.error("發布新版本失敗:", error);
            showStatus("發布失敗，請重試。", 'error');
        } finally {
            saveBtn.disabled = false;
        }
    }

    async function deleteVersion(id) {
        showStatus("正在刪除版本...");
        try {
            await deleteDoc(doc(db, versionsPath, id));
            // The onSnapshot listener will automatically refresh the view
            showStatus("版本已刪除。", 'success');
        } catch (error) {
            console.error("刪除版本失敗:", error);
            showStatus("刪除失敗，請重試。", 'error');
        }
    }

    saveBtn.addEventListener('click', saveNewVersion);
    initializeFirebase();
  </script>
</body>
</html>