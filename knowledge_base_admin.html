<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>社區知識庫管理後台</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"></link>
  <link rel="stylesheet" href="style.css">
</head>
<body class="bg-gray-50">
  <div class="max-w-4xl mx-auto p-8 bg-white shadow-xl mt-12 mb-12 rounded-2xl">
    <div class="text-center">
      <h1 class="text-4xl font-extrabold text-gray-800">社區知識庫管理後台</h1>
      <p class="text-gray-500 mt-2 text-lg">在這裡更新的資訊，會即時同步給 AI 助理</p>
    </div>

    <div id="statusMessage" class="mt-6 text-center h-8 text-sm"></div>

    <div class="mt-8 p-6 bg-blue-50 rounded-xl">
      <label for="knowledgeBaseInput" class="block text-xl font-bold text-gray-700">編輯區 (目前顯示為最新版本)</label>
      <textarea id="knowledgeBaseInput" rows="15" class="mt-3 block w-full rounded-xl border-blue-200 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-4 text-sm leading-relaxed"></textarea>
      <p class="mt-2 text-sm text-gray-500">提示：您可以使用 `#`、`**文字**`、`-` 等 Markdown 語法來美化格式。</p>
    </div>

    <div class="mt-6 text-right">
      <button id="saveBtn" class="py-3 px-8 border border-transparent rounded-full shadow-lg text-base font-bold text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-transform transform hover:-translate-y-1 disabled:bg-gray-400 disabled:transform-none">
        發布新版本
      </button>
    </div>

    <div class="mt-12 border-t pt-8">
        <h2 class="text-2xl font-bold text-gray-700 mb-6">歷史版本</h2>
        <div id="historyList" class="space-y-4"></div>
    </div>

    <div class="mt-12 border-t pt-8">
        <h2 class="text-2xl font-bold text-gray-700 mb-6">自定義快速建議按鈕</h2>
        <div id="suggestionsAdmin" class="space-y-6">
            <!-- Suggestion admin fields will be rendered here -->
        </div>
        <div class="mt-6 text-right">
            <button id="saveSuggestionsBtn" class="py-3 px-8 border border-transparent rounded-full shadow-lg text-base font-bold text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition-transform transform hover:-translate-y-1 disabled:bg-gray-400 disabled:transform-none">
                儲存建議按鈕
            </button>
        </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, collection, onSnapshot, addDoc, deleteDoc, serverTimestamp, query, orderBy, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // --- 設定 ---
    const USER_PROVIDED_API_KEY = "AIzaSyCspWUkVA6STWgjrLeXVgg5JnWnJWTKAtU";
    const SUGGESTION_BUTTONS_COUNT = 4; // 可在此調整建議按鈕的數量

    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    let firebaseConfig;
    let useTokenAuth = false;

    if (typeof __firebase_config !== 'undefined' && __firebase_config) {
        firebaseConfig = JSON.parse(__firebase_config);
        useTokenAuth = true;
    } else {
        console.warn("未偵測到 Firebase 環境設定，將使用備用設定。");
        firebaseConfig = {
            apiKey: "AIzaSyDeRHsloR1iY0_bzpYbPzdCiBljGfck98k",
            authDomain: "jy-2025.firebaseapp.com",
            projectId: "jy-2025",
            storageBucket: "jy-2025.appspot.com",
            messagingSenderId: "640527461851",
            appId: "1:640527461851:web:eed9f82d698275371fcbfe",
            measurementId: "G-HVEVMTSR9L"
        };
    }
    
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
    const versionsPath = `/artifacts/${appId}/public/data/knowledge_base_versions`;
    const suggestionsDocPath = `/artifacts/${appId}/public/data/community_info/suggestions_config`;

    // --- DOM 元素 ---
    const knowledgeBaseInput = document.getElementById('knowledgeBaseInput');
    const saveBtn = document.getElementById('saveBtn');
    const statusMessage = document.getElementById('statusMessage');
    const historyList = document.getElementById('historyList');
    const suggestionsAdmin = document.getElementById('suggestionsAdmin');
    const saveSuggestionsBtn = document.getElementById('saveSuggestionsBtn');

    // --- 全域變數 ---
    let db, auth;

    async function initializeFirebase() {
      try {
        const app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);
        
        if (useTokenAuth && initialAuthToken) {
          await signInWithCustomToken(auth, initialAuthToken);
        } else {
          await signInAnonymously(auth);
        }
        
        setupRealtimeListener();
        loadSuggestions();
      } catch (e) {
        console.error("Firebase 初始化失敗:", e);
        showStatus("無法連接至伺服器。", 'error');
      }
    }

    function showStatus(message, type = 'info') {
        const statusElement = document.getElementById('statusMessage');
        statusElement.innerHTML = message;
        statusElement.className = `mt-6 text-center h-8 text-sm flex items-center justify-center rounded-lg ${
            type === 'error' ? 'bg-red-100 text-red-700' :
            type === 'success' ? 'bg-green-100 text-green-700' : 'text-gray-500'
        }`;
        if (type === 'success') {
            setTimeout(() => {
                statusElement.innerHTML = '';
                statusElement.className = `mt-6 text-center h-8`;
            }, 3000);
        }
    }

    function setupRealtimeListener() {
        showStatus(`<i class="fas fa-spinner fa-spin mr-2"></i>正在從資料庫載入資料...`);
        saveBtn.disabled = true;
        const versionsCollectionRef = collection(db, versionsPath);
        const q = query(versionsCollectionRef, orderBy("timestamp", "desc"));

        onSnapshot(q, (snapshot) => {
            const versions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            
            if (versions.length > 0) {
                knowledgeBaseInput.value = versions[0].content;
                renderHistoryList(versions);
                showStatus("資料載入成功！", 'success');
            } else {
                knowledgeBaseInput.value = `# 歡迎使用\n\n請在此輸入您的第一版社區資訊...`;
                historyList.innerHTML = `<p class="text-gray-500 text-center">尚無歷史版本。</p>`;
                showStatus("尚未建立知識庫，請輸入內容後發布。");
            }
            saveBtn.disabled = false;
        }, (error) => {
            console.error("載入知識庫失敗:", error);
            showStatus("載入知識庫失敗，請檢查網路連線或權限設定。", 'error');
        });
    }

    function renderHistoryList(versions) {
        historyList.innerHTML = '';
        versions.forEach((version, index) => {
            const card = document.createElement('div');
            card.className = 'version-card bg-white border border-gray-200 p-4 rounded-xl flex flex-col sm:flex-row justify-between items-start sm:items-center shadow-sm';
            const timestamp = version.timestamp ? version.timestamp.toDate().toLocaleString('zh-TW') : 'N/A';
            const cleanContent = version.content.replace(/#+\s/g, '').replace(/:\w+:\w+:\d+]/g, '');
            const contentPreview = cleanContent.substring(0, 80).replace(/\n/g, ' ') + '...';

            card.innerHTML = `
                <div class="flex-grow">
                    <p class="font-bold text-gray-800 text-lg">
                        版本 ${timestamp} ${index === 0 ? '<span class="text-xs font-medium bg-green-100 text-green-800 py-1 px-2 rounded-full ml-2">最新</span>' : ''}
                    </p>
                    <p class="text-sm text-gray-500 mt-1">${contentPreview}</p>
                </div>
                <div class="flex space-x-2 mt-4 sm:mt-0">
                    <button data-content="${escape(version.content)}" class="load-btn py-2 px-4 bg-gray-100 text-gray-700 hover:bg-gray-200 rounded-lg text-sm transition-colors">載入此版本</button>
                    <button data-id="${version.id}" class="delete-btn text-red-500 hover:text-red-700 text-xl transition-colors"><i class="fas fa-trash-alt"></i></button>
                </div>
            `;
            historyList.appendChild(card);
        });

        document.querySelectorAll('.load-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                knowledgeBaseInput.value = unescape(btn.dataset.content);
                window.scrollTo(0, 0);
                showStatus("舊版內容已載入編輯區，修改後可發布為新版本。");
            });
        });

        document.querySelectorAll('.delete-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                if (confirm('您確定要永久刪除這個歷史版本嗎？此操作無法復原。')) {
                    deleteVersion(btn.dataset.id);
                }
            });
        });
    }

    async function saveNewVersion() {
        const content = knowledgeBaseInput.value;
        if (!content.trim()) {
            showStatus("內容不能為空！", "error");
            return;
        }
        showStatus(`<i class="fas fa-spinner fa-spin mr-2"></i>正在發布新版本...`);
        saveBtn.disabled = true;
        try {
            await addDoc(collection(db, versionsPath), {
                content: content,
                timestamp: serverTimestamp()
            });
            showStatus("新版本已成功發布！", 'success');
        } catch (error) {
            console.error("發布失敗:", error);
            showStatus("發布失敗，請重試。", 'error');
        } finally {
            saveBtn.disabled = false;
        }
    }

    async function deleteVersion(id) {
        showStatus(`<i class="fas fa-spinner fa-spin mr-2"></i>正在刪除版本...`);
        try {
            await deleteDoc(doc(db, versionsPath, id));
            showStatus("版本已刪除。", 'success');
        } catch (error) {
            console.error("刪除失敗:", error);
            showStatus("刪除失敗，請重試。", 'error');
        }
    }
    
    // --- Suggestions Management ---
    
    function renderSuggestionsAdmin(suggestions = []) {
        suggestionsAdmin.innerHTML = '';
        for (let i = 0; i < SUGGESTION_BUTTONS_COUNT; i++) {
            const suggestion = suggestions[i] || { zh: { text: '', query: '' }, ja: { text: '', query: '' } };
            const section = document.createElement('div');
            section.className = 'p-6 border-2 border-gray-200 rounded-xl bg-gray-100 shadow-inner';
            section.innerHTML = `
                <h3 class="font-bold text-lg mb-4 flex justify-between items-center text-gray-800">
                    <span>按鈕 ${i + 1}</span>
                    <button class="translate-btn text-sm py-2 px-4 rounded-full bg-blue-100 text-blue-700 hover:bg-blue-200 transition-colors" data-index="${i}">
                        <i class="fas fa-language mr-1"></i> 將中文翻譯至日文
                    </button>
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">按鈕文字 (中文)</label>
                        <input type="text" id="zh-text-${i}" value="${suggestion.zh.text}" class="mt-1 p-3 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">發送問題 (中文)</label>
                        <input type="text" id="zh-query-${i}" value="${suggestion.zh.query}" class="mt-1 p-3 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">按鈕文字 (日文)</label>
                        <input type="text" id="ja-text-${i}" value="${suggestion.ja.text}" class="mt-1 p-3 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">發送問題 (日文)</label>
                        <input type="text" id="ja-query-${i}" value="${suggestion.ja.query}" class="mt-1 p-3 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                    </div>
                </div>
            `;
            suggestionsAdmin.appendChild(section);
        }
        
        // Add event listeners to the new translate buttons
        document.querySelectorAll('.translate-btn').forEach(btn => {
            btn.addEventListener('click', handleTranslation);
        });
    }

    async function loadSuggestions() {
        saveSuggestionsBtn.disabled = true;
        try {
            const docRef = doc(db, suggestionsDocPath);
            const docSnap = await getDoc(docRef);
            if (docSnap.exists()) {
                renderSuggestionsAdmin(docSnap.data().suggestions);
            } else {
                renderSuggestionsAdmin(); // Render with empty fields
            }
        } catch (error) {
            console.error("載入建議按鈕失敗:", error);
            showStatus("載入建議按鈕失敗。", 'error');
        } finally {
            saveSuggestionsBtn.disabled = false;
        }
    }

    async function saveSuggestions() {
        showStatus(`<i class="fas fa-spinner fa-spin mr-2"></i>正在儲存建議按鈕...`);
        saveSuggestionsBtn.disabled = true;
        const suggestions = [];
        for (let i = 0; i < SUGGESTION_BUTTONS_COUNT; i++) {
            suggestions.push({
                zh: {
                    text: document.getElementById(`zh-text-${i}`).value,
                    query: document.getElementById(`zh-query-${i}`).value
                },
                ja: {
                    text: document.getElementById(`ja-text-${i}`).value,
                    query: document.getElementById(`ja-query-${i}`).value
                }
            });
        }
        
        try {
            const docRef = doc(db, suggestionsDocPath);
            await setDoc(docRef, { suggestions });
            showStatus("建議按鈕已成功更新！", 'success');
        } catch (error) {
            console.error("儲存建議按鈕失敗:", error);
            showStatus("儲存建議按鈕失敗。", 'error');
        } finally {
            saveSuggestionsBtn.disabled = false;
        }
    }

    // --- AI Translation Function ---
    async function translateText(text) {
        const apiKey = USER_PROVIDED_API_KEY || firebaseConfig.apiKey;
        if (!text || !apiKey) return text;

        try {
            const prompt = `Translate the following Chinese (Traditional) text to Japanese. Only return the translated text, without any explanation or extra characters. Text to translate: "${text}"`;
            const payload = { contents: [{ parts: [{ text: prompt }] }] };
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            if (!response.ok) {
                const errorBody = await response.text();
                throw new Error(`API request failed: ${response.status}. ${errorBody}`);
            }
            const result = await response.json();
            return result.candidates[0].content.parts[0].text.trim();
        } catch (error) {
            console.error('Translation failed:', error);
            showStatus(`翻譯失敗: ${error.message}`, 'error');
            return '';
        }
    }

    async function handleTranslation(event) {
        const btn = event.currentTarget;
        const index = btn.dataset.index;
        
        const zhTextInput = document.getElementById(`zh-text-${index}`);
        const zhQueryInput = document.getElementById(`zh-query-${index}`);
        const jaTextInput = document.getElementById(`ja-text-${index}`);
        const jaQueryInput = document.getElementById(`ja-query-${index}`);

        const originalButtonHTML = btn.innerHTML;
        btn.innerHTML = `<i class="fas fa-spinner fa-spin mr-1"></i> 翻譯中...`;
        btn.disabled = true;

        try {
            const [translatedText, translatedQuery] = await Promise.all([
                translateText(zhTextInput.value),
                translateText(zhQueryInput.value)
            ]);
            
            jaTextInput.value = translatedText;
            jaQueryInput.value = translatedQuery;
            showStatus('翻譯完成！', 'success');
        } catch (error) {
            // Error is already shown in translateText function
        } finally {
            btn.innerHTML = originalButtonHTML;
            btn.disabled = false;
        }
    }

    saveBtn.addEventListener('click', saveNewVersion);
    saveSuggestionsBtn.addEventListener('click', saveSuggestions);
    initializeFirebase();
  </script>
</body>
</html>